<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Avanse Funding Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Mono:wght@400;500&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0f1e;
    --surface: #111827;
    --surface2: #1a2235;
    --border: #1e2d47;
    --accent: #3b82f6;
    --accent2: #10b981;
    --accent3: #f59e0b;
    --accent4: #ef4444;
    --text: #e2e8f0;
    --muted: #64748b;
    --lien: #6366f1;
    --unlien: #10b981;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Background grid */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(59,130,246,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(59,130,246,0.03) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }

  .container { max-width: 1400px; margin: 0 auto; padding: 0 24px; position: relative; z-index: 1; }

  /* Header */
  header {
    padding: 32px 24px 24px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 16px;
    position: relative;
    z-index: 1;
  }

  .logo-area { display: flex; align-items: center; gap: 16px; }

  .logo-badge {
    width: 48px; height: 48px;
    background: linear-gradient(135deg, var(--accent), #6366f1);
    border-radius: 12px;
    display: flex; align-items: center; justify-content: center;
    font-family: 'DM Serif Display', serif;
    font-size: 22px;
    color: white;
    box-shadow: 0 0 20px rgba(59,130,246,0.4);
  }

  .header-title { font-family: 'DM Serif Display', serif; font-size: 24px; color: var(--text); }
  .header-sub { font-size: 13px; color: var(--muted); margin-top: 2px; }

  .header-right { display: flex; align-items: center; gap: 12px; }

  .status-badge {
    display: flex; align-items: center; gap: 6px;
    background: rgba(16,185,129,0.1);
    border: 1px solid rgba(16,185,129,0.3);
    border-radius: 20px;
    padding: 6px 14px;
    font-size: 12px;
    color: var(--accent2);
    font-family: 'DM Mono', monospace;
  }

  .status-dot {
    width: 6px; height: 6px;
    border-radius: 50%;
    background: var(--accent2);
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.5; transform: scale(1.3); }
  }

  .sync-btn {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 8px 16px;
    border-radius: 8px;
    font-size: 13px;
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
    transition: all 0.2s;
    display: flex; align-items: center; gap: 6px;
  }
  .sync-btn:hover { background: var(--border); border-color: var(--accent); color: var(--accent); }

  /* Main layout */
  main { padding: 32px 24px; position: relative; z-index: 1; }

  /* KPI Cards */
  .kpi-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 16px;
    margin-bottom: 32px;
  }

  .kpi-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 24px;
    position: relative;
    overflow: hidden;
    transition: transform 0.2s, box-shadow 0.2s;
  }
  .kpi-card:hover { transform: translateY(-2px); box-shadow: 0 8px 32px rgba(0,0,0,0.3); }
  .kpi-card::after {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
    background: var(--card-accent, var(--accent));
  }

  .kpi-label { font-size: 11px; text-transform: uppercase; letter-spacing: 1.5px; color: var(--muted); margin-bottom: 12px; }
  .kpi-value { font-family: 'DM Serif Display', serif; font-size: 32px; color: var(--text); line-height: 1; }
  .kpi-sub { font-size: 12px; color: var(--muted); margin-top: 8px; font-family: 'DM Mono', monospace; }
  .kpi-icon { position: absolute; top: 20px; right: 20px; font-size: 20px; opacity: 0.4; }

  /* Section header */
  .section-header {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 16px;
    flex-wrap: wrap; gap: 12px;
  }
  .section-title { font-family: 'DM Serif Display', serif; font-size: 20px; }
  .section-sub { font-size: 12px; color: var(--muted); margin-top: 2px; }

  /* Charts row */
  .charts-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    margin-bottom: 24px;
  }
  @media (max-width: 768px) { .charts-row { grid-template-columns: 1fr; } }

  .chart-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 24px;
  }
  .chart-title { font-size: 14px; font-weight: 600; margin-bottom: 20px; color: var(--text); }

  /* Donut chart */
  .donut-wrap { display: flex; align-items: center; gap: 24px; }
  .donut-svg { flex-shrink: 0; }
  .donut-legend { display: flex; flex-direction: column; gap: 12px; }
  .legend-item { display: flex; align-items: center; gap: 8px; font-size: 13px; }
  .legend-dot { width: 10px; height: 10px; border-radius: 3px; flex-shrink: 0; }
  .legend-val { font-family: 'DM Mono', monospace; font-size: 12px; color: var(--muted); }

  /* Bar chart */
  .bar-chart { display: flex; flex-direction: column; gap: 14px; }
  .bar-row { display: flex; align-items: center; gap: 12px; }
  .bar-label { font-size: 12px; color: var(--muted); width: 110px; flex-shrink: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .bar-track { flex: 1; height: 8px; background: var(--surface2); border-radius: 4px; overflow: hidden; }
  .bar-fill { height: 100%; border-radius: 4px; transition: width 0.8s cubic-bezier(0.4,0,0.2,1); }
  .bar-amount { font-size: 11px; font-family: 'DM Mono', monospace; color: var(--muted); width: 80px; text-align: right; flex-shrink: 0; }

  /* Balance bars stacked */
  .balance-track { flex: 1; height: 10px; background: var(--surface2); border-radius: 5px; overflow: hidden; display: flex; }

  /* Search & filter bar */
  .toolbar {
    display: flex; align-items: center; gap: 12px;
    margin-bottom: 16px;
    flex-wrap: wrap;
  }
  .search-wrap { position: relative; flex: 1; min-width: 200px; }
  .search-wrap input {
    width: 100%;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 10px 16px 10px 38px;
    color: var(--text);
    font-size: 13px;
    font-family: 'DM Sans', sans-serif;
    outline: none;
    transition: border-color 0.2s;
  }
  .search-wrap input:focus { border-color: var(--accent); }
  .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--muted); font-size: 14px; }

  .filter-btn {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 10px 16px;
    color: var(--muted);
    font-size: 13px;
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
    transition: all 0.2s;
  }
  .filter-btn:hover, .filter-btn.active { border-color: var(--accent); color: var(--accent); background: rgba(59,130,246,0.05); }

  /* Table */
  .table-wrap {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    overflow: hidden;
    margin-bottom: 24px;
  }

  table { width: 100%; border-collapse: collapse; }
  thead tr { background: var(--surface2); border-bottom: 1px solid var(--border); }
  thead th {
    padding: 14px 16px;
    text-align: left;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 1.2px;
    color: var(--muted);
    font-weight: 500;
    white-space: nowrap;
    cursor: pointer;
    user-select: none;
  }
  thead th:hover { color: var(--accent); }

  tbody tr {
    border-bottom: 1px solid var(--border);
    transition: background 0.15s;
  }
  tbody tr:last-child { border-bottom: none; }
  tbody tr:hover { background: var(--surface2); }

  td {
    padding: 14px 16px;
    font-size: 13px;
    vertical-align: middle;
  }

  .user-cell { display: flex; align-items: center; gap: 10px; }
  .avatar {
    width: 34px; height: 34px;
    border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    font-size: 13px; font-weight: 600;
    flex-shrink: 0;
    font-family: 'DM Mono', monospace;
  }
  .user-name { font-weight: 500; font-size: 13px; }
  .user-id { font-size: 11px; color: var(--muted); font-family: 'DM Mono', monospace; }

  .country-badge {
    display: inline-flex; align-items: center; gap: 4px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 3px 8px;
    font-size: 11px;
    color: var(--muted);
    font-family: 'DM Mono', monospace;
  }

  .amount { font-family: 'DM Mono', monospace; font-size: 13px; }
  .amount.lien { color: var(--lien); }
  .amount.unlien { color: var(--unlien); }
  .amount.zero { color: var(--muted); }

  .balance-mini { display: flex; flex-direction: column; gap: 3px; }
  .balance-row-mini { display: flex; align-items: center; gap: 6px; font-size: 11px; }
  .balance-bar-mini { width: 50px; height: 4px; background: var(--surface2); border-radius: 2px; overflow: hidden; }
  .balance-fill-mini { height: 100%; border-radius: 2px; }

  .pct-badge {
    display: inline-block;
    padding: 3px 8px;
    border-radius: 6px;
    font-size: 12px;
    font-family: 'DM Mono', monospace;
  }

  .notes-cell { font-size: 12px; color: var(--muted); max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

  .doc-link {
    display: inline-flex; align-items: center; gap: 4px;
    color: var(--accent);
    font-size: 12px;
    text-decoration: none;
    padding: 4px 8px;
    border: 1px solid rgba(59,130,246,0.3);
    border-radius: 6px;
    transition: all 0.2s;
    white-space: nowrap;
  }
  .doc-link:hover { background: rgba(59,130,246,0.1); }

  /* Config panel */
  .config-panel {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 24px;
    margin-bottom: 24px;
  }
  .config-title { font-size: 14px; font-weight: 600; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
  .config-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; }
  .config-item label { display: block; font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px; }
  .config-item input {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px 14px;
    color: var(--text);
    font-size: 13px;
    font-family: 'DM Mono', monospace;
    outline: none;
    transition: border-color 0.2s;
  }
  .config-item input:focus { border-color: var(--accent); }
  .config-actions { display: flex; gap: 10px; margin-top: 16px; }

  .btn-primary {
    background: var(--accent);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    font-size: 13px;
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
    font-weight: 500;
    transition: all 0.2s;
  }
  .btn-primary:hover { background: #2563eb; box-shadow: 0 4px 12px rgba(59,130,246,0.4); }

  .btn-secondary {
    background: transparent;
    color: var(--muted);
    border: 1px solid var(--border);
    padding: 10px 20px;
    border-radius: 8px;
    font-size: 13px;
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
    transition: all 0.2s;
  }
  .btn-secondary:hover { color: var(--text); border-color: var(--muted); }

  .info-box {
    background: rgba(59,130,246,0.05);
    border: 1px solid rgba(59,130,246,0.2);
    border-radius: 10px;
    padding: 14px 16px;
    font-size: 12px;
    color: var(--muted);
    line-height: 1.6;
    margin-top: 12px;
  }
  .info-box strong { color: var(--accent); }

  #loading {
    display: none;
    text-align: center;
    padding: 40px;
    color: var(--muted);
    font-size: 14px;
  }
  #error-msg {
    display: none;
    background: rgba(239,68,68,0.1);
    border: 1px solid rgba(239,68,68,0.3);
    border-radius: 10px;
    padding: 14px 16px;
    font-size: 13px;
    color: #fca5a5;
    margin-bottom: 16px;
  }

  /* Last updated */
  .last-updated { font-size: 11px; color: var(--muted); font-family: 'DM Mono', monospace; }

  /* Date filter bar */
  .date-filter-bar {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 16px 20px;
    margin-bottom: 24px;
    display: flex;
    align-items: center;
    gap: 16px;
    flex-wrap: wrap;
  }
  .date-filter-label {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 1.2px;
    color: var(--muted);
    flex-shrink: 0;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .date-filter-presets {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
  }
  .preset-btn {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 6px 12px;
    font-size: 12px;
    color: var(--muted);
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
    transition: all 0.2s;
    white-space: nowrap;
  }
  .preset-btn:hover { color: var(--accent); border-color: var(--accent); }
  .preset-btn.active { background: rgba(59,130,246,0.12); border-color: var(--accent); color: var(--accent); font-weight: 500; }

  .date-divider { width: 1px; height: 28px; background: var(--border); flex-shrink: 0; }

  .date-range-inputs { display: flex; align-items: center; gap: 8px; }
  .date-range-inputs input[type="date"] {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 6px 12px;
    color: var(--text);
    font-size: 12px;
    font-family: 'DM Mono', monospace;
    outline: none;
    cursor: pointer;
    transition: border-color 0.2s;
    color-scheme: dark;
  }
  .date-range-inputs input[type="date"]:focus { border-color: var(--accent); }
  .date-sep { color: var(--muted); font-size: 12px; }

  .date-clear-btn {
    background: transparent;
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 6px 10px;
    font-size: 12px;
    color: var(--muted);
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
    transition: all 0.2s;
    margin-left: 4px;
  }
  .date-clear-btn:hover { color: var(--accent4); border-color: var(--accent4); }

  .date-filter-field {
    display: flex; align-items: center; gap: 8px;
  }
  .date-field-select {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 6px 10px;
    color: var(--muted);
    font-size: 12px;
    font-family: 'DM Sans', sans-serif;
    outline: none;
    cursor: pointer;
    transition: border-color 0.2s;
  }
  .date-field-select:focus { border-color: var(--accent); color: var(--text); }

  .active-filter-tag {
    display: inline-flex; align-items: center; gap: 6px;
    background: rgba(59,130,246,0.1);
    border: 1px solid rgba(59,130,246,0.3);
    border-radius: 20px;
    padding: 4px 10px;
    font-size: 11px;
    color: var(--accent);
    font-family: 'DM Mono', monospace;
  }

  /* Responsive */
  @media (max-width: 900px) {
    .kpi-grid { grid-template-columns: repeat(2, 1fr); }
    table { font-size: 12px; }
    td, th { padding: 10px 10px; }
  }
  @media (max-width: 600px) {
    .kpi-grid { grid-template-columns: 1fr; }
    .charts-row { grid-template-columns: 1fr; }
  }

  /* Fade in animation */
  .fade-in { animation: fadeIn 0.5s ease forwards; opacity: 0; }
  @keyframes fadeIn { to { opacity: 1; } }

  .stagger-1 { animation-delay: 0.05s; }
  .stagger-2 { animation-delay: 0.1s; }
  .stagger-3 { animation-delay: 0.15s; }
  .stagger-4 { animation-delay: 0.2s; }
  .stagger-5 { animation-delay: 0.25s; }
</style>
</head>
<body>

<header>
  <div class="logo-area">
    <div class="logo-badge">A</div>
    <div>
      <div class="header-title">Avanse Funding Tracker</div>
      <div class="header-sub">Partner Dashboard ¬∑ Live Data</div>
    </div>
  </div>
  <div class="header-right">
    <div class="status-badge"><div class="status-dot"></div> Live</div>
    <button class="sync-btn" onclick="loadData()">‚Üª Sync Data</button>
    <span class="last-updated" id="last-updated">‚Äî</span>
  </div>
</header>

<main>
  <div class="container">

    <!-- Config Panel -->
    <div class="config-panel fade-in">
      <div class="config-title">‚öôÔ∏è Google Sheet Connection</div>
      <div class="config-grid">
        <div class="config-item">
          <label>Google Sheet ID</label>
          <input type="text" id="sheet-id" placeholder="Paste your Sheet ID here" value="13SL1DV39gxYyLXgGfyz5aHjpKk-XkqRA0jEGAELjb6o">
        </div>
        <div class="config-item">
          <label>Sheet / Tab Name</label>
          <input type="text" id="sheet-name" placeholder="e.g. Sheet1" value="Sheet1">
        </div>
      </div>
      <div class="config-actions">
        <button class="btn-primary" onclick="loadData()">Connect & Load Data</button>
        <button class="btn-secondary" onclick="loadSampleData()">Load Sample Data</button>
      </div>
      <div class="info-box">
        <strong>‚ö†Ô∏è Important ‚Äî host the file to connect live data:</strong> Browsers block direct Google Sheets connections when the dashboard is opened as a local file. To use live sync, host this file for free on <strong>GitHub Pages</strong> or <strong>Netlify</strong> (see instructions below), then it will connect instantly. In the meantime, use <strong>Load Sample Data</strong> to preview the dashboard.
        <br><br>
        <strong>Quickest hosting option (Netlify ‚Äî 2 minutes):</strong><br>
        1. Go to <strong>netlify.com</strong> ‚Üí sign up free<br>
        2. Drag and drop this HTML file onto the Netlify dashboard<br>
        3. You'll get a shareable link (e.g. <em>your-dashboard.netlify.app</em>)<br>
        4. Open that link ‚Üí click Connect & Load Data ‚Üí done ‚úì
      </div>
    </div>

    <div id="error-msg"></div>
    <div id="loading">‚ü≥ Loading data from Google Sheets...</div>

    <!-- KPI Cards -->
    <div class="kpi-grid" id="kpi-grid">
      <div class="kpi-card fade-in stagger-1" style="--card-accent: #6366f1;">
        <div class="kpi-icon">üí∞</div>
        <div class="kpi-label">Total Lien Funded</div>
        <div class="kpi-value" id="kpi-lien">‚Äî</div>
        <div class="kpi-sub" id="kpi-lien-count">‚Äî disbursements</div>
      </div>
      <div class="kpi-card fade-in stagger-2" style="--card-accent: #10b981;">
        <div class="kpi-icon">üè¶</div>
        <div class="kpi-label">Total Unlien Funded</div>
        <div class="kpi-value" id="kpi-unlien">‚Äî</div>
        <div class="kpi-sub" id="kpi-unlien-count">‚Äî disbursements</div>
      </div>
      <div class="kpi-card fade-in stagger-3" style="--card-accent: #f59e0b;">
        <div class="kpi-icon">‚öñÔ∏è</div>
        <div class="kpi-label">Current Lien Balance</div>
        <div class="kpi-value" id="kpi-lien-bal">‚Äî</div>
        <div class="kpi-sub">Outstanding</div>
      </div>
      <div class="kpi-card fade-in stagger-4" style="--card-accent: #3b82f6;">
        <div class="kpi-icon">üìä</div>
        <div class="kpi-label">Current Unlien Balance</div>
        <div class="kpi-value" id="kpi-unlien-bal">‚Äî</div>
        <div class="kpi-sub">Outstanding</div>
      </div>
      <div class="kpi-card fade-in stagger-5" style="--card-accent: #ec4899;">
        <div class="kpi-icon">üë§</div>
        <div class="kpi-label">Total Students</div>
        <div class="kpi-value" id="kpi-students">‚Äî</div>
        <div class="kpi-sub" id="kpi-countries">‚Äî</div>
      </div>
    </div>

    <!-- Charts -->
    <div class="charts-row">
      <div class="chart-card fade-in">
        <div class="chart-title">Lien vs Unlien Split</div>
        <div class="donut-wrap">
          <svg class="donut-svg" width="120" height="120" viewBox="0 0 120 120">
            <circle cx="60" cy="60" r="48" fill="none" stroke="#1a2235" stroke-width="18"/>
            <circle id="donut-lien" cx="60" cy="60" r="48" fill="none" stroke="#6366f1" stroke-width="18"
              stroke-dasharray="0 301.59" stroke-dashoffset="75.4" stroke-linecap="round"
              style="transition: stroke-dasharray 1s ease"/>
            <circle id="donut-unlien" cx="60" cy="60" r="48" fill="none" stroke="#10b981" stroke-width="18"
              stroke-dasharray="0 301.59" stroke-dashoffset="75.4" stroke-linecap="round"
              style="transition: stroke-dasharray 1s ease; transform: rotate(0deg); transform-origin: center"/>
            <text x="60" y="55" text-anchor="middle" fill="#e2e8f0" font-size="12" font-family="DM Serif Display">Total</text>
            <text id="donut-center" x="60" y="72" text-anchor="middle" fill="#e2e8f0" font-size="11" font-family="DM Mono">‚Äî</text>
          </svg>
          <div class="donut-legend" id="donut-legend">
            <div class="legend-item"><div class="legend-dot" style="background:#6366f1"></div><div><div style="font-size:13px">Lien Funding</div><div class="legend-val" id="legend-lien">‚Äî</div></div></div>
            <div class="legend-item"><div class="legend-dot" style="background:#10b981"></div><div><div style="font-size:13px">Unlien Funding</div><div class="legend-val" id="legend-unlien">‚Äî</div></div></div>
          </div>
        </div>
      </div>

      <div class="chart-card fade-in">
        <div class="chart-title">Funding by Student</div>
        <div class="bar-chart" id="bar-chart">
          <div style="color: var(--muted); font-size:13px;">Load data to view</div>
        </div>
      </div>
    </div>

    <!-- Date Filter Bar -->
    <div class="date-filter-bar fade-in" id="date-filter-bar">
      <div class="date-filter-label">üìÖ Filter by Date</div>

      <div class="date-filter-presets">
        <button class="preset-btn active" onclick="setPreset('all', this)">All Time</button>
        <button class="preset-btn" onclick="setPreset('this_month', this)">This Month</button>
        <button class="preset-btn" onclick="setPreset('last_month', this)">Last Month</button>
        <button class="preset-btn" onclick="setPreset('last_30', this)">Last 30 Days</button>
        <button class="preset-btn" onclick="setPreset('last_90', this)">Last 90 Days</button>
        <button class="preset-btn" onclick="setPreset('ytd', this)">Year to Date</button>
      </div>

      <div class="date-divider"></div>

      <div class="date-range-inputs">
        <span class="date-sep" style="color:var(--muted); font-size:11px; text-transform:uppercase; letter-spacing:1px;">From</span>
        <input type="date" id="date-from" onchange="onCustomDate()">
        <span class="date-sep">‚Üí</span>
        <input type="date" id="date-to" onchange="onCustomDate()">
        <button class="date-clear-btn" onclick="clearDates()" title="Clear date filter">‚úï</button>
      </div>

      <div class="date-divider"></div>

      <div class="date-filter-field">
        <span style="font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:1px;">Field</span>
        <select class="date-field-select" id="date-field" onchange="applyDateFilter()">
          <option value="created_at">Joined</option>
          <option value="date_lien">Lien Funded</option>
          <option value="date_unlien">Unlien Funded</option>
        </select>
      </div>

      <div id="active-date-tag" style="display:none" class="active-filter-tag">All Time</div>
    </div>

    <!-- Table -->
    <div class="section-header">
      <div>
        <div class="section-title">Student Funding Details</div>
        <div class="section-sub">All Avanse-funded students</div>
      </div>
    </div>

    <div class="toolbar">
      <div class="search-wrap">
        <span class="search-icon">üîç</span>
        <input type="text" id="search" placeholder="Search by name, ID, email..." oninput="filterTable()">
      </div>
      <button class="filter-btn active" onclick="setFilter('all', this)">All</button>
      <button class="filter-btn" onclick="setFilter('lien', this)">Lien Only</button>
      <button class="filter-btn" onclick="setFilter('unlien', this)">Unlien Only</button>
      <button class="filter-btn" onclick="setFilter('balance', this)">Has Balance</button>
    </div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Student</th>
            <th>Country</th>
            <th>Lien Funded</th>
            <th>Unlien Funded</th>
            <th>Lien Balance</th>
            <th>Unlien Balance</th>
            <th>% Funded</th>
            <th>Loan Letter</th>
          </tr>
        </thead>
        <tbody id="table-body">
          <tr><td colspan="8" style="text-align:center; color: var(--muted); padding: 40px;">Connect your sheet or load sample data to begin</td></tr>
        </tbody>
      </table>
    </div>

  </div>
</main>

<script>
const COLORS = ['#6366f1','#10b981','#f59e0b','#3b82f6','#ec4899','#14b8a6'];

let allData = [];
let activeFilter = 'all';

// ‚îÄ‚îÄ‚îÄ SAMPLE DATA (from your sheet) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const SAMPLE = [
  { user_id:'user000658', name:'Hiren Patel', country:'', email:'hp03978@gmail.com', created_at:'12/3/2025', lien:0, unlien:4800, date_lien:'', date_unlien:'12/22/2025', bal_lien:0, bal_unlien:0, pct:'', notes:'', doc:'' },
  { user_id:'user342432', name:'Aryan Kunwar', country:'US', email:'aryankunwarr@gmail.com', created_at:'12/29/2025', lien:96123.13, unlien:0, date_lien:'1/30/2026', date_unlien:'', bal_lien:0.75, bal_unlien:0, pct:'', notes:'', doc:'https://drive.google.com/file/d/1xr86lfJakjNu5q0jex3RLXoIXBYERB77/view?usp=sharing' },
  { user_id:'user376886', name:'Amith Kumar Yadav Komal', country:'US', email:'amith.ai.71965@gmail.com', created_at:'11/27/2025', lien:98490, unlien:4347.30, date_lien:'12/23/2025', date_unlien:'1/22/2026', bal_lien:0, bal_unlien:2266.30, pct:'', notes:'', doc:'https://drive.google.com/file/d/1781GvNcLIFsY5PQ3eXqyOt-uIpJpBIqH/view?usp=sharing' },
  { user_id:'user510211', name:'Sai Teja Chalike', country:'UK', email:'saitejachalike5@gmail.com', created_at:'11/27/2025', lien:0, unlien:34484, date_lien:'', date_unlien:'12/23/2025', bal_lien:0, bal_unlien:151.92, pct:'', notes:'', doc:'https://drive.google.com/file/d/1flCyTHCHv2kl22EMjqCwe_Lg6cHwMZp6/view?usp=sharing' },
  { user_id:'user542752', name:'Prasad Pawar', country:'US', email:'prasadpawar0093@gmail.com', created_at:'11/27/2025', lien:0, unlien:19290, date_lien:'', date_unlien:'12/4/2025', bal_lien:0, bal_unlien:3121.03, pct:'', notes:'', doc:'https://drive.google.com/file/d/1flCyTHCHv2kl22EMjqCwe_Lg6cHwMZp6/view?usp=sharing' },
  { user_id:'user576152', name:'Manjyot Padam', country:'US', email:'manjyotsingh13@gmail.com', created_at:'12/8/2025', lien:15231, unlien:0, date_lien:'12/19/2025', date_unlien:'', bal_lien:0, bal_unlien:254.92, pct:'', notes:'', doc:'https://drive.google.com/file/d/1dukSEemFsV27rZGsvJxizu9P6Ksf9M5d/view?usp=sharing' },
];

// ‚îÄ‚îÄ‚îÄ CSV PARSER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function parseCSV(text) {
  const lines = text.trim().split('\n');
  const headers = parseCSVLine(lines[0]);
  return lines.slice(1).map(line => {
    const vals = parseCSVLine(line);
    const obj = {};
    headers.forEach((h, i) => obj[h.trim()] = (vals[i] || '').trim());
    return obj;
  });
}

function parseCSVLine(line) {
  const result = [];
  let cur = '', inQuotes = false;
  for (let i = 0; i < line.length; i++) {
    const ch = line[i];
    if (ch === '"') {
      if (inQuotes && line[i+1] === '"') { cur += '"'; i++; }
      else inQuotes = !inQuotes;
    } else if (ch === ',' && !inQuotes) {
      result.push(cur); cur = '';
    } else {
      cur += ch;
    }
  }
  result.push(cur);
  return result;
}

function findCol(headers, keyword) {
  return headers.find(h => h.toLowerCase().includes(keyword.toLowerCase())) || null;
}

function parseMoney(val) {
  if (!val) return 0;
  return parseFloat(String(val).replace(/[$,\s]/g, '')) || 0;
}

// ‚îÄ‚îÄ‚îÄ GOOGLE SHEETS LOADER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadData() {
  const sheetId = document.getElementById('sheet-id').value.trim();
  const sheetName = document.getElementById('sheet-name').value.trim() || 'Sheet1';
  if (!sheetId) { showError('Please enter a Sheet ID first.'); return; }

  showError('');
  document.getElementById('loading').style.display = 'block';

  // Use CSV export URL ‚Äî works with public sheets, no CORS issues
  const gid = 0; // default first sheet; update if needed
  const url = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&sheet=${encodeURIComponent(sheetName)}`;

  try {
    const res = await fetch(url, { redirect: 'follow' });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const text = await res.text();
    if (!text || text.includes('<!DOCTYPE')) throw new Error('Not a CSV response ‚Äî sheet may not be public');

    const rows = parseCSV(text);
    if (rows.length === 0) throw new Error('No data found');

    const headers = Object.keys(rows[0]);
    const col = (kw) => findCol(headers, kw);

    const cUserId   = col('user_id');
    const cName     = col('name');
    const cCountry  = col('country');
    const cEmail    = col('email');
    const cLien     = col('lien funding');
    const cUnlien   = col('unlien funding');
    const cDateLien = col('date funded lien');
    const cDateUnlien = col('date funded unlien');
    const cBalLien  = col('current lien balance');
    const cBalUnlien = col('current unlien balance');
    const cPct      = col('percent');
    const cNotes    = col('notes');
    const cDoc      = col('loan sanction');

    allData = rows
      .filter(r => cName && r[cName] && r[cName].trim())
      .map(r => ({
        user_id:    cUserId    ? r[cUserId]    : '',
        name:       cName      ? r[cName]      : '',
        country:    cCountry   ? r[cCountry]   : '',
        email:      cEmail     ? r[cEmail]     : '',
        lien:       parseMoney(cLien     ? r[cLien]     : 0),
        unlien:     parseMoney(cUnlien   ? r[cUnlien]   : 0),
        date_lien:  cDateLien  ? r[cDateLien]  : '',
        date_unlien:cDateUnlien? r[cDateUnlien]: '',
        bal_lien:   parseMoney(cBalLien  ? r[cBalLien]  : 0),
        bal_unlien: parseMoney(cBalUnlien? r[cBalUnlien]: 0),
        pct:        cPct       ? r[cPct]       : '',
        notes:      cNotes     ? r[cNotes]     : '',
        doc:        cDoc       ? r[cDoc]       : '',
      }));

    document.getElementById('loading').style.display = 'none';
    document.getElementById('last-updated').textContent = 'Updated: ' + new Date().toLocaleTimeString();
    showError('');
    render();
  } catch(e) {
    document.getElementById('loading').style.display = 'none';
    showError(`‚ùå Could not load sheet: ${e.message}. Double-check that sharing is set to "Anyone with the link ‚Üí Viewer", then try again.`);
    console.error(e);
}

function loadSampleData() {
  allData = SAMPLE;
  document.getElementById('last-updated').textContent = 'Sample data loaded';
  render();
}

function showError(msg) {
  const el = document.getElementById('error-msg');
  el.textContent = msg;
  el.style.display = msg ? 'block' : 'none';
}

// ‚îÄ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function fmt(n) {
  if (n === 0) return '$0';
  if (n >= 1000) return '$' + (n/1000).toFixed(1) + 'K';
  return '$' + n.toFixed(2);
}
function fmtFull(n) {
  return '$' + n.toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2});
}

function render() {
  const filtered = getFilteredData();
  renderKPIs(filtered);
  renderCharts(filtered);
  renderTable(filtered);
}

function renderKPIs(data) {
  const totalLien = data.reduce((s,r) => s + r.lien, 0);
  const totalUnlien = data.reduce((s,r) => s + r.unlien, 0);
  const totalBalLien = data.reduce((s,r) => s + r.bal_lien, 0);
  const totalBalUnlien = data.reduce((s,r) => s + r.bal_unlien, 0);
  const lienCount = data.filter(r => r.lien > 0).length;
  const unlienCount = data.filter(r => r.unlien > 0).length;
  const countries = [...new Set(data.map(r => r.country).filter(Boolean))];

  document.getElementById('kpi-lien').textContent = fmt(totalLien);
  document.getElementById('kpi-lien-count').textContent = lienCount + ' disbursements';
  document.getElementById('kpi-unlien').textContent = fmt(totalUnlien);
  document.getElementById('kpi-unlien-count').textContent = unlienCount + ' disbursements';
  document.getElementById('kpi-lien-bal').textContent = fmt(totalBalLien);
  document.getElementById('kpi-unlien-bal').textContent = fmt(totalBalUnlien);
  document.getElementById('kpi-students').textContent = data.length;
  document.getElementById('kpi-countries').textContent = countries.join(', ') || 'Multiple countries';

  // Donut
  const total = totalLien + totalUnlien;
  const circ = 301.59;
  if (total > 0) {
    const lienArc = (totalLien / total) * circ;
    const unlienArc = (totalUnlien / total) * circ;
    document.getElementById('donut-lien').setAttribute('stroke-dasharray', `${lienArc} ${circ}`);
    const offset = 75.4 - lienArc;
    document.getElementById('donut-unlien').setAttribute('stroke-dasharray', `${unlienArc} ${circ}`);
    document.getElementById('donut-unlien').setAttribute('stroke-dashoffset', `${75.4 - lienArc}`);
  }
  document.getElementById('donut-center').textContent = fmt(total);
  document.getElementById('legend-lien').textContent = fmtFull(totalLien);
  document.getElementById('legend-unlien').textContent = fmtFull(totalUnlien);
}

function renderCharts(data) {
  const maxTotal = Math.max(...data.map(r => r.lien + r.unlien), 0);
  const html = data.slice(0,8).map((r, i) => {
    const total = r.lien + r.unlien;
    const lienPct = maxTotal > 0 ? (r.lien / maxTotal * 100) : 0;
    const unlienPct = maxTotal > 0 ? (r.unlien / maxTotal * 100) : 0;
    const name = r.name.split(' ')[0];
    return `<div class="bar-row">
      <div class="bar-label" title="${r.name}">${name}</div>
      <div style="flex:1">
        <div class="bar-track" style="height:10px; display:flex;">
          <div class="bar-fill" style="width:${lienPct}%; background:#6366f1; border-radius:4px 0 0 4px;"></div>
          <div class="bar-fill" style="width:${unlienPct}%; background:#10b981; border-radius:0 4px 4px 0;"></div>
        </div>
      </div>
      <div class="bar-amount">${fmt(total)}</div>
    </div>`;
  }).join('');
  document.getElementById('bar-chart').innerHTML = html || '<div style="color:var(--muted)">No data</div>';
}

function initials(name) {
  return name.split(' ').slice(0,2).map(w=>w[0]).join('').toUpperCase();
}

function renderTable(data) {
  if (!data) data = getFilteredData();

  if (data.length === 0) {
    document.getElementById('table-body').innerHTML = '<tr><td colspan="8" style="text-align:center; color:var(--muted); padding:40px;">No matching students found</td></tr>';
    return;
  }

  const html = data.map((r, i) => {
    const color = COLORS[i % COLORS.length];
    const pct = r.pct ? `<span class="pct-badge" style="background:rgba(59,130,246,0.1); color:var(--accent)">${r.pct}</span>` : '<span style="color:var(--muted)">‚Äî</span>';
    const docLink = r.doc ? `<a href="${r.doc}" target="_blank" class="doc-link">üìÑ View</a>` : '<span style="color:var(--muted); font-size:12px">‚Äî</span>';
    const country = r.country ? `<span class="country-badge">${r.country}</span>` : '‚Äî';

    return `<tr>
      <td>
        <div class="user-cell">
          <div class="avatar" style="background:${color}22; color:${color}">${initials(r.name)}</div>
          <div>
            <div class="user-name">${r.name}</div>
            <div class="user-id">${r.user_id}</div>
          </div>
        </div>
      </td>
      <td>${country}</td>
      <td><span class="amount ${r.lien>0?'lien':'zero'}">${r.lien>0?fmtFull(r.lien):'‚Äî'}</span></td>
      <td><span class="amount ${r.unlien>0?'unlien':'zero'}">${r.unlien>0?fmtFull(r.unlien):'‚Äî'}</span></td>
      <td><span class="amount ${r.bal_lien>0?'lien':'zero'}">${r.bal_lien>0?fmtFull(r.bal_lien):'$0.00'}</span></td>
      <td><span class="amount ${r.bal_unlien>0?'unlien':'zero'}">${r.bal_unlien>0?fmtFull(r.bal_unlien):'$0.00'}</span></td>
      <td>${pct}</td>
      <td>${docLink}</td>
    </tr>`;
  }).join('');

  document.getElementById('table-body').innerHTML = html;
}

// ‚îÄ‚îÄ‚îÄ DATE FILTER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let dateFrom = null;
let dateTo = null;

function parseDate(str) {
  if (!str) return null;
  // Handle M/D/YYYY or MM/DD/YYYY
  const parts = str.split('/');
  if (parts.length === 3) {
    return new Date(parseInt(parts[2]), parseInt(parts[0])-1, parseInt(parts[1]));
  }
  // Handle YYYY-MM-DD
  const d = new Date(str);
  return isNaN(d) ? null : d;
}

function setPreset(preset, btn) {
  document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');

  const now = new Date();
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

  if (preset === 'all') {
    dateFrom = null; dateTo = null;
    document.getElementById('date-from').value = '';
    document.getElementById('date-to').value = '';
    updateDateTag('All Time', false);
  } else if (preset === 'this_month') {
    dateFrom = new Date(today.getFullYear(), today.getMonth(), 1);
    dateTo = new Date(today.getFullYear(), today.getMonth()+1, 0);
    updateDateTag('This Month');
  } else if (preset === 'last_month') {
    dateFrom = new Date(today.getFullYear(), today.getMonth()-1, 1);
    dateTo = new Date(today.getFullYear(), today.getMonth(), 0);
    updateDateTag('Last Month');
  } else if (preset === 'last_30') {
    dateFrom = new Date(today - 30*86400000);
    dateTo = today;
    updateDateTag('Last 30 Days');
  } else if (preset === 'last_90') {
    dateFrom = new Date(today - 90*86400000);
    dateTo = today;
    updateDateTag('Last 90 Days');
  } else if (preset === 'ytd') {
    dateFrom = new Date(today.getFullYear(), 0, 1);
    dateTo = today;
    updateDateTag('Year to Date');
  }

  // Sync inputs
  if (dateFrom) document.getElementById('date-from').value = toInputDate(dateFrom);
  if (dateTo) document.getElementById('date-to').value = toInputDate(dateTo);

  applyDateFilter();
}

function toInputDate(d) {
  return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
}

function onCustomDate() {
  const fromVal = document.getElementById('date-from').value;
  const toVal = document.getElementById('date-to').value;
  dateFrom = fromVal ? new Date(fromVal) : null;
  dateTo = toVal ? new Date(toVal + 'T23:59:59') : null;
  document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
  const label = (fromVal || toVal) ? `${fromVal||'‚Ä¶'} ‚Üí ${toVal||'‚Ä¶'}` : 'All Time';
  updateDateTag(label, !!(fromVal || toVal));
  applyDateFilter();
}

function clearDates() {
  dateFrom = null; dateTo = null;
  document.getElementById('date-from').value = '';
  document.getElementById('date-to').value = '';
  document.querySelectorAll('.preset-btn').forEach((b,i) => { if(i===0) b.classList.add('active'); else b.classList.remove('active'); });
  updateDateTag('All Time', false);
  applyDateFilter();
}

function updateDateTag(label, show=true) {
  const tag = document.getElementById('active-date-tag');
  tag.textContent = label;
  tag.style.display = show ? 'inline-flex' : 'none';
}

function applyDateFilter() {
  render();
}

function getFilteredData() {
  const field = document.getElementById('date-field') ? document.getElementById('date-field').value : 'created_at';
  const search = document.getElementById('search').value.toLowerCase();

  return allData.filter(r => {
    // Search
    const matchSearch = !search ||
      r.name.toLowerCase().includes(search) ||
      r.user_id.toLowerCase().includes(search) ||
      r.email.toLowerCase().includes(search);

    // Type filter
    const matchFilter =
      activeFilter === 'all' ? true :
      activeFilter === 'lien' ? r.lien > 0 :
      activeFilter === 'unlien' ? r.unlien > 0 :
      activeFilter === 'balance' ? (r.bal_lien > 0 || r.bal_unlien > 0) : true;

    // Date filter
    let matchDate = true;
    if (dateFrom || dateTo) {
      const raw = r[field];
      const d = parseDate(raw);
      if (!d) {
        matchDate = false;
      } else {
        if (dateFrom && d < dateFrom) matchDate = false;
        if (dateTo && d > dateTo) matchDate = false;
      }
    }

    return matchSearch && matchFilter && matchDate;
  });
}

function filterTable() { render(); }

function setFilter(f, btn) {
  activeFilter = f;
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  render();
}


// Auto-load sample on start
loadSampleData();
</script>
</body>
</html>
